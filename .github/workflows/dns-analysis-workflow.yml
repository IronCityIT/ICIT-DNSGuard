name: DNS Guard - Security Analysis

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to analyze'
        required: true
      client_name:
        description: 'Client name'
        required: false
        default: 'Free Scan'
      scan_id:
        description: 'Unique scan ID for session isolation'
        required: false
      enable_subdomains:
        description: 'Enable subdomain enumeration'
        default: 'true'
        type: boolean

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      findings_json: ${{ steps.scan.outputs.findings_json }}
      scan_id: ${{ steps.scan.outputs.scan_id }}
      report_file: ${{ steps.scan.outputs.report_file }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install dnspython requests
      
      - name: Run DNS Analysis
        id: scan
        env:
          DOMAIN: ${{ github.event.inputs.domain }}
          CLIENT_NAME: ${{ github.event.inputs.client_name }}
          SCAN_ID: ${{ github.event.inputs.scan_id }}
          ENABLE_SUBDOMAINS: ${{ github.event.inputs.enable_subdomains }}
        run: |
          # Generate scan ID if not provided (for session isolation)
          if [ -z "$SCAN_ID" ]; then
            SCAN_ID="scan-$(date +%s)-$(echo $RANDOM | md5sum | head -c 8)"
          fi
          echo "scan_id=$SCAN_ID" >> $GITHUB_OUTPUT
          
          # Run analysis
          python src/core/analyzer.py "$DOMAIN" \
            -c "$CLIENT_NAME" \
            $([[ "$ENABLE_SUBDOMAINS" == "true" ]] && echo "-s") \
            -o "dnsguard-report.json"
          
          # Add scan_id to the report
          jq --arg sid "$SCAN_ID" '. + {scan_id: $sid}' dnsguard-report.json > temp.json
          mv temp.json dnsguard-report.json
          
          # Output findings for AI Consensus Engine
          FINDINGS=$(cat dnsguard-report.json | jq -c '.findings // []')
          echo "findings_json<<EOF" >> $GITHUB_OUTPUT
          echo "$FINDINGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "report_file=dnsguard-report.json" >> $GITHUB_OUTPUT
          
          echo "=== Scan Complete ==="
          cat dnsguard-report.json | jq '{domain, risk_score: .overall_risk_score, email_grade: .email_security.grade, findings_count: (.findings | length)}'
      
      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dnsguard-report-${{ steps.scan.outputs.scan_id }}
          path: dnsguard-report.json

  # AI Consensus Engine - Analyzes findings with 15 AI models
  ai-consensus:
    needs: analyze
    if: ${{ needs.analyze.outputs.findings_json != '[]' && needs.analyze.outputs.findings_json != 'null' && needs.analyze.outputs.findings_json != '' }}
    uses: IronCityIT/consensus-engine/.github/workflows/analyze.yml@main
    with:
      findings_json: ${{ needs.analyze.outputs.findings_json }}
      product: 'dnsguard'
      context: 'dns-email-security-analysis'
    secrets:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

  # Store results in Firestore
  store-results:
    needs: [analyze, ai-consensus]
    if: always() && needs.analyze.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download scan report
        uses: actions/download-artifact@v4
        with:
          name: dnsguard-report-${{ needs.analyze.outputs.scan_id }}
      
      - name: Merge AI Consensus Analysis
        run: |
          # Check if AI consensus completed and has output
          CONSENSUS_JSON='${{ needs.ai-consensus.outputs.consensus_json }}'
          CONSENSUS_SEVERITY='${{ needs.ai-consensus.outputs.consensus_severity }}'
          CONFIDENCE='${{ needs.ai-consensus.outputs.confidence_percent }}'
          
          if [ -n "$CONSENSUS_JSON" ] && [ "$CONSENSUS_JSON" != "null" ] && [ "$CONSENSUS_JSON" != "" ]; then
            echo "âœ… Merging AI Consensus analysis..."
            echo "   Severity: $CONSENSUS_SEVERITY"
            echo "   Confidence: $CONFIDENCE%"
            
            # Add AI analysis to the report
            jq --arg sev "$CONSENSUS_SEVERITY" \
               --arg conf "$CONFIDENCE" \
               --argjson ai "$CONSENSUS_JSON" \
               '. + {
                 ai_analysis: $ai,
                 ai_consensus_severity: $sev,
                 ai_confidence_percent: ($conf | tonumber)
               }' dnsguard-report.json > merged.json
            mv merged.json dnsguard-report.json
          else
            echo "âš ï¸ No AI consensus available (findings may be empty or engine skipped)"
          fi
          
          echo "=== Final Report ==="
          cat dnsguard-report.json | jq '{domain, scan_id, risk_score: .overall_risk_score, ai_severity: .ai_consensus_severity, ai_confidence: .ai_confidence_percent}'
      
      - name: POST to Cloud Function
        env:
          CLOUD_FUNCTION_URL: ${{ secrets.DNSGUARD_CLOUD_FUNCTION_URL }}
        run: |
          # Use default URL if secret not set
          URL="${CLOUD_FUNCTION_URL:-https://storescanresults-43248247502.us-east5.run.app}"
          
          echo "ðŸ“¤ Posting results to Firestore..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$URL" \
            -H "Content-Type: application/json" \
            -d @dnsguard-report.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response ($HTTP_CODE): $BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            SCAN_ID=$(echo "$BODY" | jq -r '.id // .scan_id // empty')
            echo ""
            echo "âœ… SUCCESS!"
            echo "ðŸ”— Dashboard: https://icit-dnsguard.web.app/?scan=$SCAN_ID"
          else
            echo "âŒ Failed to store results"
            exit 1
          fi
      
      - name: Job Summary
        run: |
          DOMAIN=$(jq -r '.domain' dnsguard-report.json)
          GRADE=$(jq -r '.email_security.grade // "N/A"' dnsguard-report.json)
          RISK=$(jq -r '.overall_risk_score // 0' dnsguard-report.json)
          FINDINGS=$(jq -r '.findings | length' dnsguard-report.json)
          SUBS=$(jq -r '.subdomains | length' dnsguard-report.json)
          SCAN_ID=$(jq -r '.scan_id' dnsguard-report.json)
          AI_SEV=$(jq -r '.ai_consensus_severity // "N/A"' dnsguard-report.json)
          AI_CONF=$(jq -r '.ai_confidence_percent // "N/A"' dnsguard-report.json)
          SUMMARY=$(jq -r '.executive_summary // "Analysis complete."' dnsguard-report.json)
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ›¡ï¸ DNS Guard Analysis Complete
          
          **Domain:** \`$DOMAIN\`
          
          | Metric | Value |
          |--------|-------|
          | Email Security Grade | **$GRADE** |
          | Risk Score | $RISK/100 |
          | Security Findings | $FINDINGS |
          | Subdomains Found | $SUBS |
          | AI Consensus Severity | $AI_SEV |
          | AI Confidence | $AI_CONF% |
          
          ### ðŸ“ Executive Summary
          $SUMMARY
          
          ### ðŸ”— View Full Report
          **[Open Dashboard](https://icit-dnsguard.web.app/?scan=$SCAN_ID)**
          
          ---
          *Analyzed by Iron City DNS Guard with AI Consensus Engine (15 models)*
          EOF
