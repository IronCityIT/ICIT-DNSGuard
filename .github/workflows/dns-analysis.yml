name: DNS Guard - Security Analysis

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to analyze'
        required: true
      client_name:
        description: 'Client name'
        required: true
        default: 'Demo'
      scan_id:
        description: 'Unique scan identifier'
        required: false
      enable_subdomains:
        description: 'Enable subdomain enumeration'
        required: false
        default: 'true'
      enable_threat_intel:
        description: 'Enable threat intelligence'
        required: false
        default: 'true'

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      findings_b64: ${{ steps.extract.outputs.findings_b64 }}
      has_findings: ${{ steps.extract.outputs.has_findings }}
      scan_id: ${{ github.run_id }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt || pip install dnspython requests

      - name: Run DNS Analysis
        id: scan
        run: |
          mkdir -p reports
          CMD="python src/cli.py -d '${{ inputs.domain }}' -c '${{ inputs.client_name }}' -o ./reports"
          [ "${{ inputs.enable_subdomains }}" = "true" ] && CMD="$CMD -s"
          [ "${{ inputs.enable_threat_intel }}" = "true" ] && CMD="$CMD -t -g"
          echo "Running: $CMD"
          eval $CMD
          REPORT=$(ls -t reports/*.json | head -1)
          echo "report_file=$REPORT" >> $GITHUB_OUTPUT

      - name: Extract findings
        id: extract
        run: |
          REPORT="${{ steps.scan.outputs.report_file }}"
          FINDINGS=$(cat "$REPORT" | jq -c '.findings // []')
          echo "findings_b64=$(echo "$FINDINGS" | base64 -w0)" >> $GITHUB_OUTPUT
          [ "$FINDINGS" != "[]" ] && echo "has_findings=true" >> $GITHUB_OUTPUT || echo "has_findings=false" >> $GITHUB_OUTPUT

      - name: Post to QNAP API
        env:
          API_URL: https://api.ironcityit.com/ingest
          API_KEY: ${{ secrets.IRONCITY_API_KEY }}
        run: |
          REPORT="${{ steps.scan.outputs.report_file }}"
          curl -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $API_KEY" \
            -d @"$REPORT"

  ai-consensus:
    needs: analyze
    if: needs.analyze.outputs.has_findings == 'true'
    uses: IronCityIT/consensus-engine/.github/workflows/analyze.yml@main
    with:
      findings_b64: ${{ needs.analyze.outputs.findings_b64 }}
      scan_id: ${{ needs.analyze.outputs.scan_id }}
      product: dnsguard
    secrets: inherit
