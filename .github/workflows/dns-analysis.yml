name: DNS Guard - Security Analysis

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to analyze'
        required: true
      client_name:
        description: 'Client name'
        required: true
        default: 'Demo'

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      findings_b64: ${{ steps.extract.outputs.findings_b64 }}
      has_findings: ${{ steps.extract.outputs.has_findings }}
      scan_id: ${{ github.run_id }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt || pip install dnspython requests

      - name: Run DNS Analysis
        id: scan
        run: |
          mkdir -p reports
          python src/cli.py -d "${{ inputs.domain }}" -o ./reports
          REPORT=$(ls -t reports/*.json | head -1)
          echo "report_file=$REPORT" >> $GITHUB_OUTPUT

      - name: Post initial results to Firestore
        id: post
        env:
          CLOUD_FUNCTION_URL: ${{ secrets.DNSGUARD_CLOUD_FUNCTION_URL }}
        run: |
          REPORT="${{ steps.scan.outputs.report_file }}"
          jq --arg sid "${{ github.run_id }}" --arg dom "${{ inputs.domain }}" \
            '. + {scan_id: $sid, domain: $dom}' "$REPORT" > /tmp/upload.json
          curl -s -X POST "$CLOUD_FUNCTION_URL" -H "Content-Type: application/json" -d @/tmp/upload.json
          echo "Posted initial scan"

      - name: Extract findings
        id: extract
        run: |
          REPORT="${{ steps.scan.outputs.report_file }}"
          FINDINGS=$(jq -c '.findings // []' "$REPORT")
          COUNT=$(echo "$FINDINGS" | jq 'length')
          if [ "$COUNT" -gt 0 ]; then
            echo "findings_b64=$(echo "$FINDINGS" | base64 -w0)" >> $GITHUB_OUTPUT
            echo "has_findings=true" >> $GITHUB_OUTPUT
          else
            echo "has_findings=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: dns-report
          path: reports/

  ai-consensus:
    needs: analyze
    if: needs.analyze.outputs.has_findings == 'true'
    uses: IronCityIT/consensus-engine/.github/workflows/analyze.yml@main
    with:
      findings_json: ${{ needs.analyze.outputs.findings_b64 }}
      product: 'dns-guard'
      client_id: ${{ inputs.client_name }}
      scan_id: ${{ needs.analyze.outputs.scan_id }}
      firestore_url: ${{ vars.DNSGUARD_CLOUD_FUNCTION_URL }}
    secrets:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
